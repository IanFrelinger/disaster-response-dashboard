# Test-enabled Frontend Dockerfile
FROM node:18-alpine AS base

# Set working directory
WORKDIR /app

# Install system dependencies for testing
RUN apk add --no-cache \
    chromium \
    nss \
    freetype \
    freetype-dev \
    harfbuzz \
    ca-certificates \
    ttf-freefont \
    && rm -rf /var/cache/apk/*

# Set environment variables for Chromium
ENV CHROME_BIN=/usr/bin/chromium-browser
ENV CHROME_PATH=/usr/lib/chromium/
ENV PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=true
ENV PUPPETEER_EXECUTABLE_PATH=/usr/bin/chromium-browser

# Copy package files
COPY package*.json ./

# Install all dependencies (including dev dependencies for testing)
RUN npm ci

# Copy source code
COPY . .

# Install Playwright browsers
RUN npx playwright install --with-deps chromium firefox webkit

# Create test directories
RUN mkdir -p /app/test-results /app/coverage-reports /app/playwright-reports

# Build the application
RUN npm run build

# Test stage
FROM base AS test

# Set environment variables for testing
ENV NODE_ENV=test
ENV CI=true
ENV DISPLAY=:99

# Expose port for development server
EXPOSE 3000

# Default command for running tests
CMD ["npx", "playwright", "test", "tests/e2e/comprehensive-ui-test.spec.ts", "--reporter=html"]

# Production stage (same as original)
FROM nginx:alpine AS production

# Copy built application from build stage
COPY --from=base /app/dist /usr/share/nginx/html

# Copy nginx configuration
COPY nginx.conf /etc/nginx/nginx.conf

# Expose port 80
EXPOSE 80

# Start nginx
CMD ["nginx", "-g", "daemon off;"]
